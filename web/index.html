<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Loose JSON | TOML normalizer</title>
    <link rel="icon"
        href="https://raw.githubusercontent.com/shellyln/go-loose-json-parser/master/_assets/logo-go-jsonlp.svg"
        type="image/svg+xml">

    <script src="wasm_exec.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.min.css"
        integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/codemirror.min.js"
        integrity="sha512-rdFIN28+neM8H8zNsjRClhJb1fIYby2YCNmoqwnqBDEvZgpcp7MJiX8Wd+Oi6KcJOMOuvGztjrsI59rly9BsVQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/javascript/javascript.min.js"
        integrity="sha512-Cbz+kvn+l5pi5HfXsEB/FYgZVKjGIhOgYNBwj4W2IHP2y8r3AdyDCQRnEUqIQ+6aJjygKPTyaNT2eIihaykJlw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.11/mode/toml/toml.min.js"
        integrity="sha512-O6QYGRZVa6FLNVTWPdLXXiVC4pNCVA6NNVW29i7qHFprs/Wat4QrjSKjINcoCT+2IySTFmfIoIp2yZmWoafQsg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body {
            font-family:
                "Helvetica Neue",
                Arial,
                "Hiragino Kaku Gothic ProN",
                "Hiragino Sans",
                Meiryo,
                sans-serif;
        }
        .input-area .CodeMirror {
            border: 1px solid #eee;
            height: calc((100vh - 70px) * 0.66);
            margin: 3px;
        }
        .output-area .CodeMirror {
            border: 1px solid #eee;
            height: calc((100vh - 70px) * 0.33);
            margin: 3px;
        }
    </style>
    <script>
        {
            const go = new Go();

            // https://github.com/tinygo-org/tinygo/issues1140#issuecomment-671261465
            //go.importObject.env["syscall/js.finalizeRef"] = ()=> {};

            WebAssembly.instantiateStreaming(fetch("go.wasm"), go.importObject).then((result) => {
                const mod = result.module;
                go.run(result.instance);
                globalThis.goWasmExports = result.instance.exports;

                globalThis.rebootGoApplication = async () => {
                    const inst = await WebAssembly.instantiate(mod, go.importObject);
                    go.run(inst);
                }
            });
        }
    </script>
</head>
<body>
    <div style="display: flex;">
        <h4 style="margin: 0 auto 0 0;"><img
            src="https://raw.githubusercontent.com/shellyln/go-loose-json-parser/master/_assets/logo-go-jsonlp.svg"
            alt="logo" style="width:20px; margin-right: 0.55rem; vertical-align: middle;">Loose JSON | TOML normalizer</h4>
        <div style="font-size: smaller;">Powered by <a href="https://github.com/shellyln/go-loose-json-parser"
            target="_blank"
            style="color: unset;"
            >go-loose-json-parser</a></div>
    </div>
    <div>
        <div class="input-area">
            <textarea id="loosejson" name="loosejson" rows="35" cols="120"
>[
    // comment
    1, 2, 3, 4,
]
</textarea>
        </div>
        <div>
            <form name="form1">
                <button onclick="execNormalize(event)">Normalize loose JSON/TOML</button>
                <span style="margin-left: 2em;">Indent:</span>
                <select name="indent">
                    <option value="0" selected>0</option>
                    <option value="2">2</option>
                    <option value="4">4</option>
                    <option value="8">8</option>
                </select>
                <span style="margin-left: 1em;"></span>
                <input type="radio" id="lang-json" name="lang" value="json" checked onchange="changeLang(event)">
                <label for="lang-json">JSON</label>
                <input type="radio" id="lang-toml" name="lang" value="toml" onchange="changeLang(event)">
                <label for="lang-toml">TOML</label>
            </form>
        </div>
    </div>
    <div>
        <div class="output-area">
            <textarea id="result-area"></textarea>
        </div>
    </div>

    <script>
        const myCodeMirrorIn = CodeMirror.fromTextArea(document.querySelector('#loosejson'), {mode:'javascript', lineNumbers: true});
        const myCodeMirrorOut = CodeMirror.fromTextArea(document.querySelector('#result-area'), {mode:'javascript', lineNumbers: true, lineWrapping: true});

        function changeLang(event) {
            if (event.target.value === 'toml') {
                myCodeMirrorIn.setOption('mode', 'toml');
            } else {
                myCodeMirrorIn.setOption('mode', 'javascript');
            }
        }

        function execNormalize(event) {
            event.preventDefault();
            try {
                let indent = Number(document.querySelector('select[name=indent]')?.value ?? '0');
                let lang;
                for (const item of document.form1.lang) {
                    if (item.checked) {
                        lang = item.value;
                    }
                }
                let result;
                if (lang === 'toml') {
                    result = normalizeTOML(myCodeMirrorIn.getDoc().getValue(), indent);
                } else {
                    result = normalizeJSON(myCodeMirrorIn.getDoc().getValue(), indent);
                }
                myCodeMirrorOut.getDoc().setValue(result);
            } catch(e) {
                rebootGoApplication();
                myCodeMirrorOut.getDoc().setValue(e.message ?? e);
            }
        }
    </script>
</body>
</html>
